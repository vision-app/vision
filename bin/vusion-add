#!/usr/bin/env node

const path = require('path');
const chalk = require('chalk');
const fs = require('fs-extra');
const { fs: vfs, ms: vms } = require('vusion-api');
const inquirer = require('inquirer');
inquirer.registerPrompt('autocomplete', require('inquirer-autocomplete-prompt'));
inquirer.registerPrompt('fuzzypath', require('inquirer-fuzzy-path'));
const fuzzy = require('fuzzy');
const ora = require('ora');
const logger = require('../lib/logger');

/**
 * Parse Commands
 */
const program = require('commander');
program
    .usage('<type> [source] [target]')
    .description(`Add a kind of material: ${chalk.yellow('block')}, ${chalk.yellow('module')} or ${chalk.yellow('page')}`)
    .option('--name <name>', 'Rename material in target path')
    .option('--title <title>', 'Set title to replace material content')
    .option('--skip', 'Skip questions and execute command quickly');

const oldOutputHelp = program.outputHelp;
program.outputHelp = function (cb) {
    oldOutputHelp.call(program, (text) => {
        const colored = text
            .replace(/^Usage: (.+)\n/mg, (m, $1) => 'Usage: ' + chalk.cyan($1) + '\n');
            // .replace(/^ {2}(\w+)/mg, (m, $1) => '  ' + chalk.yellow($1));
        const more = `\nFor examples:
  vusion add block
  vusion add block @cloud-ui/s-basic-form.vue ./src/something/create.vue
  vusion add module
  vusion add module ./templates/module2 ./src/views/dashboard
  vusion add page
`;
        const result = colored + more;
        return cb ? cb(result) : result;
    });
};

program.parse(process.argv);

const configurator = require('../lib/configurator');
const config = configurator.load();
/**
 * Execute Command
 */
async function add(args) {
    let materialType = program.args[0];
    if (!materialType) {
        const { type } = await inquirer.prompt([{
            name: 'type',
            type: 'list',
            message: 'Which kind of material do you want to add?',
            default: 'block',
            choices: ['block', 'module', 'page'],
        }]);

        materialType = type;
    }

    if (materialType === 'module') {
        const options = {
            source: program.args[1],
            target: program.args[2],
            name: program.name,
            title: program.title,
        };

        // Ask questions
        if (!program.skip) {
            if (!options.source) {
                inquirer.prompt([{
                    name: 'source',
                    type: 'input',
                    message: 'Please specify a module template path. Default is',
                    default: './templates/module',
                    // when: options.
                }, {
                    name: 'target',
                    type: 'input',
                    message: 'Please specify a module template path. Default is',
                    default: './templates/module',
                }]).then((result) => {
                    console.log(result);
                });
            }
        }

        // Ask questions

        // vms.addModule(options).then(() => {
        //     console.log('Success!');
        // });
    } else if (materialType === 'block') {
        const options = {
            source: program.args[1],
            target: program.args[2],
            name: program.name,
        };

        // Ask questions
        if (!program.skip) {
            if (!options.source) {
                let sourceType = config.default_registry;

                if (!sourceType) {
                    const sourceResult = await inquirer.prompt([{
                        name: 'sourceType',
                        type: 'list',
                        message: `Select a source registry ${chalk.gray('(输入中英文均可搜索)')}:`,
                        default: config.default_registry,
                        choices: Object.keys(config.registries).map((key) => ({
                            name: key + ' ' + chalk.gray(`(${config.registries[key]})`),
                            value: key,
                        })),
                    }]);
                    sourceType = sourceResult.sourceType;
                }

                // if (registry.endsWith('npm')) {
                const spinner = ora('Loading blocks...').start();
                let blocks = await vms.getBlocks();
                blocks = blocks.map((block) => {
                    let name = block.name + ' ' + chalk.yellow(`(${block.title})`);
                    if (block.description && block.description !== block.title)
                        name += chalk.gray(` - ${block.description}`);
                    return {
                        name,
                        value: block.name,
                        short: block.name + ' ' + chalk.yellow(`(${block.title})`),
                    };
                });
                spinner.stop();

                const { block } = await inquirer.prompt([{
                    name: 'block',
                    type: 'autocomplete',
                    message: `Select a block:`,
                    source(answersSoFar, input) {
                        if (!input)
                            return Promise.resolve(blocks);
                        else {
                            return Promise.resolve(fuzzy.filter(input, blocks, {
                                extract(item) { return item.name; },
                            }).map((item) => blocks[item.index]));
                        }
                    },
                }]);

                options.source = {
                    type: sourceType,
                    registry: config.registries[sourceType],
                    name: block,
                };
            } else {
                options.source = {
                    type: config.default_registry,
                    registry: config.registries[config.default_registry],
                    name: options.source,
                };
            }

            if (!options.target) {
                const fileList = vfs.listAllFiles('', {
                    patterns: ['!node_modules'],
                    includes: /\.vue$/,
                }).sort();
                const { target } = await inquirer.prompt([{
                    name: 'target',
                    type: 'autocomplete',
                    // type: 'fuzzypath', // 这个不太好用
                    message: `Select a target vue file to add block:`,
                    source(answersSoFar, input) {
                        if (!input)
                            return Promise.resolve(fileList);
                        else {
                            return Promise.resolve(fuzzy.filter(input, fileList, {
                                // pre: style.green.open,
                                // post: style.green.close,
                            }).map((item) => item.string));
                            //  ({
                            //     name: item.string,
                            //     value: item.original,
                            //     short: item.original,
                            // })));
                        }
                    },
                }]);

                options.target = target;

                console.info();
                console.info(`The target vue file may be changed in the process. Make sure it saved in your editor.`);
                const { ok } = await inquirer.prompt([{
                    name: 'ok',
                    type: 'confirm',
                    message: `Confirm to continue?`,
                }]);

                if (ok) {
                    try {
                        console.info();
                        console.info(`✨  Adding block ${chalk.yellow(options.source.name)} in ${chalk.cyan(options.target)}`);
                        const spinner = ora(` This might take a while...`).start();
                        await vms.addBlock(options);
                        spinner.stop();
                        console.info();
                        logger.done(`Successfully added block ${chalk.yellow(options.source.name)}.`);
                    } catch (e) {
                        console.error(e);
                    }
                }
            }
        }
    }
    // if (materialType !== 'component' && materialType !== 'block')
    //     throw new Error('Unsupport material type!');

    // const materialName = program.args[1] || 'u-sample';

    // vfs.createMultiFilePackage(path.join(process.cwd(), 'src', materialType + 's'), materialName).then((dest) => {
    //     console.info('Success! You can run serveral commands:');
    //     console.info('Start the development server:');
    //     console.info('    cd ' + path.relative(process.cwd(), dest));
    //     console.info('    npm install');
    //     console.info('    npm run doc');
    // });
}

add();
