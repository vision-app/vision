#!/usr/bin/env node

const path = require('path');
const logger = require('../lib/logger');
const exec = require('../lib/exec');
const vusion = require('vusion-api');

/**
 * Parse Commands
 */
const program = require('commander');
program
    .usage('<action> <key> <value>')
    .description(`Configure CLI options

Commands:
  list                            List all config
  set <key> <value>               Set an option value. For example: vusion config set access_token f2224e629a7e24423e6b1bf6
  get <key>                       Get a value of an option. For example: vusion config get access_token
  delete <key>                    Delete a option. For example: vusion config delete default_registry
  add registry <manager> <url>    Add a pair of manager and registry. For example: vusion config add registry cnpm https://registry.npm.taobao.org
  remove registry <manager>       Remove a pair of manager and registry. For example: vusion config remove registry cnpm
  edit                            Use vim to edit config directly
`)
    .parse(process.argv);

const configurator = vusion.rc.configurator;
const config = configurator.load();

let [action, key, value, url] = program.args;

if (action === 'set') {
    if (key === 'platform')
        value = value.replace(/\/$/, '');

    config[key] = value;
    configurator.save();
    logger.done(key + '=' + value);
} else if (action === 'get') {
    console.info(config[key]);
} else if (action === 'delete') {
    delete config[key];
    configurator.save();
    logger.done('Deleted key ' + key);
} else if (action === 'add') {
    if (key === 'registry') {
        url = url.replace(/\/$/, '');

        config.registries = config.registries || {};
        config.registries[value] = url;
        configurator.save();
        logger.done(value + '=' + url);
    }
} else if (action === 'remove') {
    if (key === 'registry') {
        config.registries = config.registries || {};
        delete config.registries[value];
        configurator.save();
        logger.done('Remove registry ' + value);
    }
} else if (action === 'list') {
    console.info(configurator.yaml);
} else if (action === 'edit') {
    exec('vi', [configurator.rcPath]);
} else {
    logger.error('Unknown action of vusion-config!');
    process.exit(1);
}
