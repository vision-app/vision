#!/usr/bin/env node

const path = require('path');
const logger = require('../lib/logger');
const exec = require('../lib/exec');

/**
 * Parse Commands
 */
const program = require('commander');
program
    .usage('<action> <key> <value>')
    .description(`Configure CLI options:
list                            List all config
set <key> <value>               For example: vusion config set access_token f2224e629a7e24423e6b1bf6
get <key>                       For example: vusion config get access_token
delete <key>                    For example: vusion config delete default_registry
add registry <manager> <url>    For example: vusion config add registry cnpm https://registry.npm.taobao.org
remove registry <manager>       For example: vusion config remove registry cnpm
edit                            Use vim to edit config directly
`)
    .parse(process.argv);

const configurator = require('../lib/configurator');
const config = configurator.load();

const [action, key, value, url] = program.args;

if (action === 'set') {
    config[key] = value;
    configurator.save();
    logger.done(key + '=' + value);
} else if (action === 'get') {
    console.info(config[key]);
} else if (action === 'delete') {
    delete config[key];
    configurator.save();
    logger.done('Deleted key ' + key);
} else if (action === 'add') {
    if (key === 'registry') {
        config.registries = config.registries || {};
        config.registries[value] = url;
        configurator.save();
        logger.done(value + '=' + url);
    }
} else if (action === 'remove') {
    if (key === 'registry') {
        config.registries = config.registries || {};
        delete config.registries[value];
        configurator.save();
        logger.done('Remove registry ' + value);
    }
} else if (action === 'list') {
    console.info(configurator.yaml);
} else if (action === 'edit') {
    exec('vi', [configurator.rcPath]);
} else {
    logger.error('Unknown action!');
    process.exit(1);
}
